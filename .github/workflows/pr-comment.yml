name: PR Validation Comment

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  validate-and-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run PR validation report
        id: validate
        run: |
          set +e
          REPORT=$(python3 scripts/pr_validation_report.py --base origin/main 2>&1)
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> "$GITHUB_OUTPUT"
          # Write report to file to avoid shell escaping issues
          echo "$REPORT" > /tmp/pr_report.json
          set -e

      - name: Post PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let report;
            try {
              const raw = fs.readFileSync('/tmp/pr_report.json', 'utf8');
              report = JSON.parse(raw);
            } catch (e) {
              report = {
                status: 'fail',
                affected_skills: [],
                errors: [`Failed to parse validation report: ${e.message}`],
                warnings: [],
                summary: 'Validation report could not be generated.'
              };
            }

            const icon = report.status === 'pass' ? ':white_check_mark:' : ':x:';
            let body = `## ${icon} Skill Validation Report\n\n`;
            body += `**Status:** ${report.status.toUpperCase()}\n\n`;
            body += `${report.summary}\n\n`;

            if (report.affected_skills.length === 0) {
              body += `_No skills were affected by this PR._\n`;
            } else {
              body += `### Affected Skills\n\n`;
              body += `| Skill | Path | Errors | Warnings |\n`;
              body += `|-------|------|--------|----------|\n`;
              for (const skill of report.affected_skills) {
                const errCount = skill.errors.length;
                const warnCount = skill.warnings.length;
                const errIcon = errCount > 0 ? ':x:' : ':white_check_mark:';
                body += `| ${skill.name} | \`${skill.path}\` | ${errIcon} ${errCount} | ${warnCount} |\n`;
              }
            }

            if (report.errors.length > 0) {
              body += `\n### Errors\n\n`;
              for (const err of report.errors) {
                body += `- :x: ${err}\n`;
              }
            }

            if (report.warnings.length > 0) {
              body += `\n### Warnings\n\n`;
              for (const warn of report.warnings) {
                body += `- :warning: ${warn}\n`;
              }
            }

            body += `\n---\n_Generated by PR Validation workflow_`;

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const marker = 'Skill Validation Report';
            const existing = comments.find(c =>
              c.user.type === 'Bot' && c.body.includes(marker)
            );

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Fail on validation errors
        if: steps.validate.outputs.exit_code != '0'
        run: exit 1
