name: Validate

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Validate frontmatter
        run: |
          python3 scripts/validate_skills.py --collection example --unique --check-links
          python3 scripts/validate_skills.py --collection document --unique --check-links

      - name: Ensure generated files are up to date
        run: |
          python3 scripts/refresh_skill_collections.py
          git diff --exit-code

      - name: Validate generated bundles
        run: |
          python3 scripts/validate_generated_dirs.py

      - name: Validate directory structure
        run: |
          [ -d "skills" ] || { echo "ERROR: skills/ directory missing"; exit 1; }
          [ -d ".build" ] || { echo "ERROR: .build/ directory missing"; exit 1; }
          # Verify no skill directories at root level
          for dir in */; do
            if [ -f "${dir}SKILL.md" ] && [ "$dir" != "skills/" ] && [ "$dir" != "document-skills/" ]; then
              echo "ERROR: Skill directory at root level: $dir"
              exit 1
            fi
          done
          # Verify skills are organized into category subdirectories
          for item in skills/*/; do
            if [ -f "${item}SKILL.md" ]; then
              echo "ERROR: Skill at top level of skills/: $item (should be in a category)"
              exit 1
            fi
          done
          echo "Directory structure validated"

      - name: Check for secrets in new files
        if: github.event_name == 'pull_request'
        run: |
          CHANGED=$(git diff --diff-filter=ACMR --name-only origin/main...HEAD)
          if [ -z "$CHANGED" ]; then
            echo "No changed files to scan"
            exit 0
          fi
          MATCHES=$(echo "$CHANGED" | xargs grep -rlE 'sk-|ghp_|AKIA' || true)
          if [ -n "$MATCHES" ]; then
            echo "ERROR: Potential secrets detected in:"
            echo "$MATCHES"
            exit 1
          fi
          echo "No secrets detected"
